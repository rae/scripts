#!/usr/bin/perl -ws
# renames screenshots on the desktop to 2020-02-02.1234.55.ext
#
my $dir = "$ENV{HOME}/Desktop";

sub d(@) {
	return unless $v;
	print @_;
	print "\n";
}

sub dd(@) {
	return unless $v;
	print @_;
}

if(scalar @ARGV > 0) {
	$dir = $ARGV[0];
	shift;
}
chdir($dir);

dd("PWD is ", `pwd`);

# Screen Recording 2020-11-19 at 18.13.50.mov

for my $ss (<"Screen *">) {
	d("ss-rename: checking \"$ss\"");
	if($ss =~ /Screen (Recording|Shot) (\d\d\d\d-\d\d-\d\d) at (\d+)\.(\d\d\.\d\d)( [AP]M)?\.(\w\w\w)/) {
		my $date = $2;
		my $hour = $3;
		my $minutes = $4;
		d("ss-rename: renaming \"$ss\"");
		my $time=$3;
		my $ext = $6;
		if(defined $5 && $5 eq " PM") {
			dd("ss-rename: adding 12 hours to $hour,");
			$hour += 12;
			d(" \"$hour\"");
		}
		$hour = "0${hour}" if $hour < 10;
		my $newname="${date}.${hour}${minutes}.${ext}";
		if(-e $newname) {
			warn "$0: \"$newname\" already exists. skipping $ss\n";
			next;
		}
		d("ss-rename: renaming to \"$newname\"");
		rename $ss, $newname || print("ss-rename: renaming failed: $!\n");
	}
	elsif($ss =~ /Screen (Recording|Shot) (\d\d\d\d\-\d\d-\d\d) at (\d+)\.(\d\d\.\d\d) (am|pm)(.*)\.([a-z]+)$/i) {
		my $date = $2;
		my $hour = $3;
		my $minsec = $4;
		my $extra = $6;
		my $ext = $7;
		$hour += 12 if $5 =~ /[Pp][Mm]/;
		my $newname="${date}.${hour}${minsec}${extra}.${ext}";
		if(-e $newname) {
			warn "$0: \"$newname\" already exists. skipping $ss\n";
			next;
		}
		d("ss-rename: renaming \"$ss\"");
		d("ss-rename: to \"$newname\"");
		rename $ss, $newname;
	}
	else {
		d("No match: \"$ss\"");
	}
}

# Simulator Screen Shot - iPhone Xs Max (UAT, FR) - 2018-12-04 at 15.26.31
for my $ss (<"Simulator Screen Shot*">) {
	if($ss =~ /Simulator Screen Shot - (.*) - (\d\d\d\d\-\d\d-\d\d) at (\d\d)\.(\d\d\.\d\d)\.([a-z][a-z][a-z])/) {
		my $newname="simulator.${2}.${3}${4}.${1}.${5}";
		if(-e $newname) {
			warn "$0: \"$newname\" already exists. skipping $ss\n";
			next;
		}
		rename $ss, $newname;
	}
}
